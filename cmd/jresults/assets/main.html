<html>
  <head>
    <title>JMeter results from {{ .StartTime.Format "Jan 02, 2006 15:04:05 EST" }}</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/taucharts/latest/tauCharts.min.css">
  </head>
  <body class="container">
    <h1>JMeter results from {{ .StartTime.Format "Jan 02, 2006 15:04:05 EST" }}</h1>
    <table class="table table-striped table-bordered table-hover table-condensed table-responsive">
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" value="check all" checked></th>
          <th>Label</th>
          <th>Samples</th>
          <th>Mean (msec)</th>
          <th>Std. Dev. (msec)</th>
          <th>Median (msec)</th>
          <th>95 Percentile (msec)</th>
          <th>% Error (Count)</th>
        </tr>
      </thead>
      <tbody>
        {{ range .StatResults }}
        <tr>
          <td><input type="checkbox" id="{{ .Label  }}" value="{{ .Label }}" class="labels" checked></td>
          <td>{{- .Label }}</td>
          <td class="text-right">{{- .Samples }}</td>
          <td class="text-right">{{- printf "%6.3f" .Mean }}</td>
          <td class="text-right">{{- printf "%6.3f" .StandardDeviation }}</td>
          <td class="text-right">{{- .Median }}</td>
          <td class="text-right">{{- .Percent95 }}</td>
          <td class="text-right">{{- printf "%6.1f" .ErrorPercent }} ({{ .Errors }})</td>
        </tr>
        {{ end  }}
        <tfoot>
          <tr>
            <td></td>
            <th>Totals:</th>
            <td class="text-right">{{- .Totals.Samples }}</td>
            <td class="text-right">{{- printf "%6.3f" .Totals.Mean }}</td>
            <td class="text-right">{{- printf "%6.3f" .Totals.StandardDeviation }}</td>
            <td class="text-right">{{- .Totals.Median }}</td>
            <td class="text-right">{{- .Totals.Percent95 }}</td>
            <td class="text-right">{{- printf "%6.1f" .Totals.ErrorPercent }} ({{ .Totals.Errors }})</td>
          </tr>
        </tfoot>
      </tbody>
    </table>
    <div id="chart"></div>
    <script src="https://cdn.jsdelivr.net/d3js/latest/d3.min.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/underscorejs/latest/underscore-min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/taucharts/latest/tauCharts.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.1.0.slim.min.js"
      integrity="sha256-cRpWjoSOw5KcyIOaZNo4i6fZ9tKPhYYb6i5T9RSVJG8="
      crossorigin="anonymous"></script>
    <script type="text/javascript">
     var jsonData = {{ .StatResultsJSON }};
     var startTime = {{ .StartTime.Unix }};
     var dataRaw = JSON.parse(jsonData);
     var chartData = [];

     $(function() {
       function updateData() {
         chartData = [];
         var labels = _.chain($('table').find('.labels')).
                        map(function(item) {
                          var $item = $(item);
                          if ($item.is(":checked")) {
                            return $item.val();
                          }
                        }).
                        compact().
                        value();
         console.log(labels);
         _.each(dataRaw, function(jstat) {
           if (_.contains(labels, jstat.Label)) {
             _.each(jstat.Elapsed, function(val, i) {
               /* var d = new Date(0);*/
               var row = {type: jstat.Label, 'elapsed': (val/1000.0), 'time': ((jstat.TimeStamps[i] - (startTime*1000))/1000)};
               chartData.push(row);
             });
           }
         });
       }
       updateData();

       function drawChart() {
         $('#chart').empty();
         var chart = new tauCharts.Chart({
           data: chartData,
           type: 'scatterplot',
           x: 'time',
           y: 'elapsed',
           color: 'type', // there will be two lines with different colors on the chart
           guide: {
             x: {label: {text: 'Relative Time Since Start (secords)', padding: 35}, padding: 20},
             y: {label: 'Response Time (seconds)', padding: 20},
             showGridLines: 'xy'
           },
           plugins: [
             tauCharts.api.plugins.get('tooltip')()
           ]
         }).renderTo('#chart');
       }
       drawChart();

       $(".labels").click(function() {
         updateData();
         drawChart();
       });

       $('#checkAll').click(function() {
         var $elm = $(this);
         console.log($elm.is(":checked"));
         if ($elm.first().is(":checked")) {
           $('.labels').each(function() {
             $(this).prop('checked', true);
           });
         } else {
           $('.labels').each(function() {
             $(this).prop('checked', false);
           });
         }
         updateData();
         drawChart();
       });

     });
    </script>
  </body>
</html>
